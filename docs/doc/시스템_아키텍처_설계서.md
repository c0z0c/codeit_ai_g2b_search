---
layout: default
title: "[ì¤‘ê¸‰í”„ë¡œì íŠ¸] - RAG ê¸°ë°˜ PEP ë¬¸ì„œ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ì„œ"
description: "RAG ì‹œìŠ¤í…œì˜ ìƒì„¸ ì•„í‚¤í…ì²˜ ë° êµ¬í˜„ êµ¬ì¡°"
date: 2025-11-08
cache-control: no-cache
expires: 0
pragma: no-cache
author: "ê¹€ëª…í™˜"
mermaid: true
math: true
---

# RAG ê¸°ë°˜ PEP ë¬¸ì„œ ì²˜ë¦¬ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ì„œ

> ë³¸ ë¬¸ì„œëŠ” **Mermaid ë‹¤ì´ì–´ê·¸ë¨**ê³¼ **LaTeX ìˆ˜ì‹**ì„ í¬í•¨í•©ë‹ˆë‹¤.
> GitHub Pagesì—ì„œ ìµœì ìœ¼ë¡œ ë Œë”ë§ë˜ë©°, ì‹œìŠ¤í…œ êµ¬ì¡°ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì „ì²´ ì•„í‚¤í…ì²˜](#ì „ì²´-ì•„í‚¤í…ì²˜)
3. [ëª¨ë“ˆ êµ¬ì¡°](#ëª¨ë“ˆ-êµ¬ì¡°)
4. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
5. [í•µì‹¬ ì»´í¬ë„ŒíŠ¸](#í•µì‹¬-ì»´í¬ë„ŒíŠ¸)
6. [ê¸°ìˆ  ìŠ¤íƒ](#ê¸°ìˆ -ìŠ¤íƒ)
7. [ë””ë ‰í† ë¦¬ êµ¬ì¡°](#ë””ë ‰í† ë¦¬-êµ¬ì¡°)

---

## ì‹œìŠ¤í…œ ê°œìš”

### ëª©ì 
PDF/HWP í˜•íƒœì˜ PEP(ê³µê³µë°ì´í„° í¬í„¸) ë¬¸ì„œë¥¼ ìˆ˜ì§‘í•˜ê³ , RAG(Retrieval-Augmented Generation) ê¸°ìˆ ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ì§ˆì˜ì— ëŒ€í•œ ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œ

### ì£¼ìš” ê¸°ëŠ¥
- PDF ë¬¸ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° í˜ì´ì§€ë³„ ê´€ë¦¬
- ë¬¸ì„œ ì²­í‚¹ ë° ë²¡í„° ì„ë² ë”© ìƒì„±
- í†µí•© FAISS ì¸ë±ìŠ¤ ê¸°ë°˜ ìœ ì‚¬ë„ ê²€ìƒ‰ (íŒŒì¼ëª…, í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
- LangChain ê¸°ë°˜ RAG ë‹µë³€ ìƒì„±
- Streamlit ê¸°ë°˜ ëŒ€í™”í˜• UI
- ì±„íŒ… íˆìŠ¤í† ë¦¬ ê´€ë¦¬

### í•µì‹¬ ì„¤ê³„ ì›ì¹™
- **ëª¨ë“ˆí™”**: ê° ê¸°ëŠ¥ë³„ ë…ë¦½ì ì¸ ëª¨ë“ˆ êµ¬ì„±
- **í™•ì¥ì„±**: ìƒˆë¡œìš´ ë¬¸ì„œ íƒ€ì… ë° ëª¨ë¸ ì¶”ê°€ ìš©ì´
- **ì¶”ì ì„±**: íŒŒì¼ í•´ì‹œ ê¸°ë°˜ ë°ì´í„° ì¶”ì 
- **íš¨ìœ¨ì„±**: ìºì‹± ë° ì¦ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›

---

## ì „ì²´ ì•„í‚¤í…ì²˜

### ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
graph TB
    subgraph UI["ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ"]
        WebUI["Streamlit Web UI<br/>- ë¬¸ì„œ ì—…ë¡œë“œ<br/>- ì±„íŒ… ì¸í„°í˜ì´ìŠ¤<br/>- ì„¸ì…˜ ê´€ë¦¬<br/>- í†µê³„ ëŒ€ì‹œë³´ë“œ"]
    end

    subgraph APP["ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ"]
        DocProc["DocumentProcessor<br/>- PDF íŒŒì‹±<br/>- í˜ì´ì§€ë³„ í…ìŠ¤íŠ¸ ì¶”ì¶œ"]
        EmbProc["EmbeddingProcessor<br/>- í…ìŠ¤íŠ¸ ì²­í‚¹<br/>- ë²¡í„° ì„ë² ë”©<br/>- í†µí•© FAISS ì¸ë±ì‹±"]
        LLMProc["LLM & Retrieval<br/>- ì¿¼ë¦¬ ì„ë² ë”©<br/>- ìœ ì‚¬ë„ ê²€ìƒ‰<br/>- LLM ë‹µë³€ ìƒì„±"]
    end

    subgraph DAL["ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ"]
        DocsDB["DocumentsDB<br/>- TB_DOCUMENTS"]
        VectorMgr["VectorStoreManager<br/>- FAISS ì¸ë±ìŠ¤ ê´€ë¦¬<br/>- ë©”íƒ€ë°ì´í„° ê´€ë¦¬"]
        ChatDB["ChatHistoryDB<br/>- chat_sessions<br/>- chat_messages"]
    end

    subgraph STORAGE["ë°ì´í„° ì €ì¥ì†Œ"]
        SQLite1[("documents.db<br/>(SQLite)")]
        SQLite2[("chat_history.db<br/>(SQLite)")]
        FAISS[("í†µí•© FAISS Index<br/>vectorstore.faiss<br/>ë©”íƒ€ë°ì´í„° í¬í•¨")]
    end

    WebUI --> DocProc
    WebUI --> EmbProc
    WebUI --> LLMProc

    DocProc --> DocsDB
    EmbProc --> DocsDB
    EmbProc --> VectorMgr
    LLMProc --> VectorMgr
    LLMProc --> ChatDB

    DocsDB --> SQLite1
    ChatDB --> SQLite2
    VectorMgr --> FAISS

    style UI stroke-width:2px,stroke:#e1f5ff
    style APP stroke-width:2px,stroke:#fff9e1
    style DAL stroke-width:2px,stroke:#e8f5e9
    style STORAGE stroke-width:2px,stroke:#fce4ec
```

### ê³„ì¸µë³„ ì—­í• 

#### 1. ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ (UI Layer)
- **ì±…ì„**: ì‚¬ìš©ìì™€ì˜ ìƒí˜¸ì‘ìš©
- **êµ¬ì„±ìš”ì†Œ**: Streamlit ê¸°ë°˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜
- **ì£¼ìš” ê¸°ëŠ¥**:
  - ë¬¸ì„œ ì—…ë¡œë“œ ë° ì²˜ë¦¬ íŠ¸ë¦¬ê±°
  - ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ì œê³µ
  - ì„¸ì…˜ ê´€ë¦¬
  - ì‹¤ì‹œê°„ í†µê³„ í‘œì‹œ

#### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ (Application Layer)
- **ì±…ì„**: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- **êµ¬ì„±ìš”ì†Œ**:
  - DocumentProcessor: ë¬¸ì„œ ë³€í™˜ ë° ì €ì¥
  - EmbeddingProcessor: ì„ë² ë”© ìƒì„± ë° ì¸ë±ì‹±
  - Retrieval: ê²€ìƒ‰ ê¸°ëŠ¥
  - LLMProcessor: ë‹µë³€ ìƒì„±

#### 3. ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ (Data Access Layer)
- **ì±…ì„**: ë°ì´í„°ë² ì´ìŠ¤ CRUD ì—°ì‚° ë° ë²¡í„° ì¸ë±ìŠ¤ ê´€ë¦¬
- **êµ¬ì„±ìš”ì†Œ**:
  - DocumentsDB: ë¬¸ì„œ í…ìŠ¤íŠ¸ ì½˜í…ì¸  ê´€ë¦¬
  - VectorStoreManager: FAISS ì¸ë±ìŠ¤ ë° ë©”íƒ€ë°ì´í„° í†µí•© ê´€ë¦¬
  - ChatHistoryDB: ì±„íŒ… ì„¸ì…˜ ë° ë©”ì‹œì§€ ê´€ë¦¬

#### 4. ë°ì´í„° ì €ì¥ì†Œ ê³„ì¸µ (Data Storage Layer)
- **ì±…ì„**: ì˜êµ¬ ë°ì´í„° ì €ì¥
- **êµ¬ì„±ìš”ì†Œ**:
  - SQLite ë°ì´í„°ë² ì´ìŠ¤ (2ê°œ: documents.db, chat_history.db)
  - FAISS ë²¡í„° ì¸ë±ìŠ¤ íŒŒì¼ (ë©”íƒ€ë°ì´í„° í¬í•¨)

---

## ëª¨ë“ˆ êµ¬ì¡°

### 1. ë¬¸ì„œ ì²˜ë¦¬ ëª¨ë“ˆ (Document Processing Module)

#### ìœ„ì¹˜
```
src/processors/document_processor.py
```

#### í´ë˜ìŠ¤: DocumentProcessor

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class DocumentProcessor:
    def __init__(self, db_path: str = 'data/documents.db')
    def calculate_file_hash(self, file_path: Path) -> str
    def process_pdf(self, pdf_path: str) -> Optional[str]
```

**ì²˜ë¦¬ íë¦„**:

```mermaid
flowchart TD
    A[PDF íŒŒì¼ ì…ë ¥] --> B[íŒŒì¼ í•´ì‹œ ê³„ì‚°<br/>SHA-256]
    B --> C[PyMuPDFë¡œ<br/>í˜ì´ì§€ë³„ í…ìŠ¤íŠ¸ ì¶”ì¶œ]
    C --> D{í˜ì´ì§€ ë‚´ìš©<br/>í™•ì¸}
    D -->|ë¹ˆ í˜ì´ì§€| E1[ë¹ˆ í˜ì´ì§€ í‘œì‹œ]
    D -->|ì¼ë°˜ í˜ì´ì§€| E2[í˜ì´ì§€ í…ìŠ¤íŠ¸ ì €ì¥]
    E1 --> F[documents.db ì €ì¥]
    E2 --> F
    F --> F1[file_info í…Œì´ë¸”]
    F --> F2[page_data í…Œì´ë¸”]
    F1 --> G[íŒŒì¼ í•´ì‹œ ë°˜í™˜]
    F2 --> G

    style A stroke-width:2px,stroke:#e1f5ff
    style G stroke-width:2px,stroke:#c8e6c9
```

**ì˜ì¡´ì„±**:
- PyMuPDF (pymupdf): PDF íŒŒì‹±
- DocumentsDB: ë°ì´í„° ì €ì¥

---

### 2. ì„ë² ë”© ì²˜ë¦¬ ëª¨ë“ˆ (Embedding Processing Module)

#### ìœ„ì¹˜
```
src/processors/embedding_processor.py
```

#### í´ë˜ìŠ¤: EmbeddingProcessor

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class EmbeddingProcessor:
    def __init__(
        self,
        config=None
    )
    def process_document(self, file_hash: str, api_key: Optional[str] = None) -> bool
```

**ì£¼ìš” ì†ì„±**:
- `vector_manager`: VectorStoreManager ì¸ìŠ¤í„´ìŠ¤
- `docs_db`: DocumentsDB ì¸ìŠ¤í„´ìŠ¤
- `text_splitter`: RecursiveCharacterTextSplitter ì¸ìŠ¤í„´ìŠ¤

**ì²˜ë¦¬ íë¦„**:

```mermaid
flowchart TD
    A[íŒŒì¼ í•´ì‹œ ì…ë ¥] --> B[DocumentsDBì—ì„œ<br/>í…ìŠ¤íŠ¸ ì½˜í…ì¸  ì¡°íšŒ]
    B --> C[í˜ì´ì§€ë³„ í…ìŠ¤íŠ¸ ì¤€ë¹„<br/>í˜ì´ì§€ ìœ„ì¹˜ ì¶”ì ]
    C --> D[RecursiveCharacterTextSplitter<br/>ì²­í‚¹]
    D --> D1[chunk_size: 1000]
    D --> D2[chunk_overlap: 200]
    D --> D3["separators: [\n\n, \n, ' ', '']"]
    D1 --> E[ì²­í¬ë³„ í˜ì´ì§€ ë²”ìœ„ ê³„ì‚°<br/>start_page, end_page]
    D2 --> E
    D3 --> E
    E --> F[ë©”íƒ€ë°ì´í„° ìƒì„±<br/>file_hash, file_name,<br/>start_page, end_page,<br/>chunk_index]
    F --> G[VectorStoreManager<br/>add_texts í˜¸ì¶œ]
    G --> G1{FAISS ì¸ë±ìŠ¤<br/>ì¡´ì¬?}
    G1 -->|Yes| G2[ê¸°ì¡´ ì¸ë±ìŠ¤ ë¡œë“œ]
    G1 -->|No| G3[ìƒˆ ì¸ë±ìŠ¤ ìƒì„±]
    G2 --> H[OpenAI APIë¡œ<br/>ì„ë² ë”© ë²¡í„° ìƒì„±]
    G3 --> H
    H --> I[FAISS ì¸ë±ìŠ¤ì— ë²¡í„° ì¶”ê°€<br/>ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ ì €ì¥]
    I --> J[VectorStoreManager.save<br/>vectorstore.faiss]
    J --> K[ì²˜ë¦¬ ì™„ë£Œ]

    style A stroke-width:2px,stroke:#e1f5ff
    style K stroke-width:2px,stroke:#c8e6c9
    style H stroke-width:2px,stroke:#fff9e1
    style I stroke-width:2px,stroke:#ffe0b2
```

**í†µí•© FAISS ê´€ë¦¬ íŠ¹ì§•**:
- **ë‹¨ì¼ ì¸ë±ìŠ¤**: ëª¨ë“  ë¬¸ì„œì˜ ì„ë² ë”©ì„ í•˜ë‚˜ì˜ FAISS ì¸ë±ìŠ¤ì— ì €ì¥
- **ë©”íƒ€ë°ì´í„° í†µí•©**: Document.metadataì— íŒŒì¼ëª…, í˜ì´ì§€ ë²ˆí˜¸, ì²­í¬ ì •ë³´ ëª¨ë‘ ì €ì¥
- **ì¦ë¶„ ì—…ë°ì´íŠ¸**: ìƒˆ ë¬¸ì„œ ì¶”ê°€ ì‹œ ê¸°ì¡´ ì¸ë±ìŠ¤ì— ë²¡í„° ì¶”ê°€
- **í†µí•© ê²€ìƒ‰**: ì „ì²´ ë¬¸ì„œë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œ ë²ˆì— ìœ ì‚¬ë„ ê²€ìƒ‰
- **ë³„ë„ DB ë¶ˆí•„ìš”**: EmbeddingsDB ì œê±°, FAISS ë‚´ë¶€ ë©”íƒ€ë°ì´í„°ë§Œ ì‚¬ìš©

**ì˜ì¡´ì„±**:
- LangChain: í…ìŠ¤íŠ¸ ë¶„í•  ë° ì„ë² ë”©
- FAISS: ë²¡í„° ì¸ë±ì‹± ë° ë©”íƒ€ë°ì´í„° ì €ì¥
- OpenAI API: ì„ë² ë”© ìƒì„±
- VectorStoreManager: FAISS ì¸ë±ìŠ¤ ê´€ë¦¬
- DocumentsDB: ì›ë³¸ ë¬¸ì„œ í…ìŠ¤íŠ¸ ê´€ë¦¬

---

### 3. ê²€ìƒ‰ ëª¨ë“ˆ (Retrieval Module)

#### ìœ„ì¹˜
```
src/llm/retrieval.py
```

#### í´ë˜ìŠ¤: Retrieval

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class Retrieval:
    def __init__(
        self,
        embedding_model: str = "text-embedding-3-small",
        vector_path: str = "data/vectorstore/vectorstore.faiss"
    )
    def search(
        self,
        query: str,
        top_k: int = 5,
        api_key: Optional[str] = None
    ) -> List[Dict[str, Any]]
```

**ê²€ìƒ‰ íë¦„**:

```mermaid
flowchart TD
    A[ì‚¬ìš©ì ì¿¼ë¦¬ ì…ë ¥] --> B[VectorStoreManager<br/>search í˜¸ì¶œ]
    B --> C[ì¿¼ë¦¬ë¥¼ ë²¡í„°ë¡œ ì„ë² ë”©<br/>OpenAI API]
    C --> D[FAISS ìœ ì‚¬ë„ ê²€ìƒ‰<br/>L2 distance]
    D --> D1[ì „ì²´ ë¬¸ì„œ ëŒ€ìƒ ê²€ìƒ‰]
    D1 --> D2[top_kê°œ ì²­í¬ ê²€ìƒ‰]
    D2 --> D3[Documents + distance ë°˜í™˜]
    D3 --> E[Document.metadataì—ì„œ<br/>ì •ë³´ ì¶”ì¶œ]
    E --> E1[íŒŒì¼ëª… ì¶”ì¶œ]
    E --> E2[í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ]
    E --> E3[ì²­í¬ í…ìŠ¤íŠ¸ ì¶”ì¶œ]
    E1 --> F[ê²€ìƒ‰ ê²°ê³¼ êµ¬ì„±]
    E2 --> F
    E3 --> F
    F --> F1[distance ê°’ ê·¸ëŒ€ë¡œ í¬í•¨]
    F1 --> G[ê²€ìƒ‰ ê²°ê³¼ ë°˜í™˜]
    G --> G1["[(Document, distance), ...]"]

    style A stroke-width:2px,stroke:#e1f5ff
    style G1 stroke-width:2px,stroke:#c8e6c9
    style D stroke-width:2px,stroke:#fff9e1
    style F1 stroke-width:2px,stroke:#ffe0b2
```

**ê²€ìƒ‰ ê²°ê³¼ êµ¬ì¡°**:
```python
# VectorStoreManager.search() ë°˜í™˜ê°’
List[Tuple[Document, float]]

# Document êµ¬ì¡°
Document(
    page_content=str,        # ì²­í¬ í…ìŠ¤íŠ¸
    metadata={
        'file_name': str,    # íŒŒì¼ëª…
        'file_hash': str,    # íŒŒì¼ í•´ì‹œ
        'start_page': int,   # ì‹œì‘ í˜ì´ì§€ ë²ˆí˜¸
        'end_page': int,     # ì¢…ë£Œ í˜ì´ì§€ ë²ˆí˜¸
        'chunk_index': int,  # ì²­í¬ ì¸ë±ìŠ¤
        'chunk_type': str,   # ì²­í¬ íƒ€ì…
        'embedding_version': str,
        'created_at': str
    }
)

# float: L2 distance (ì‘ì„ìˆ˜ë¡ ìœ ì‚¬ë„ ë†’ìŒ)
```

**í†µí•© ê²€ìƒ‰ì˜ ì¥ì **:
- ì „ì²´ ë¬¸ì„œë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œ ë²ˆì— ê²€ìƒ‰
- Document.metadataì— ëª¨ë“  ì •ë³´ í¬í•¨ (ë³„ë„ DB ì¡°íšŒ ë¶ˆí•„ìš”)
- íŒŒì¼ëª…ê³¼ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ í†µí•œ ì •í™•í•œ ì¶œì²˜ ì¶”ì 
- ì—¬ëŸ¬ ë¬¸ì„œì— ê±¸ì¹œ ê´€ë ¨ ì •ë³´ í†µí•© ì œê³µ

**ì˜ì¡´ì„±**:
- VectorStoreManager: FAISS ì¸ë±ìŠ¤ ë° ë©”íƒ€ë°ì´í„° ê´€ë¦¬
- FAISS: ë²¡í„° ê²€ìƒ‰ (LangChain í†µí•©)
- OpenAI API: ì¿¼ë¦¬ ì„ë² ë”©

---

### 4. LLM ì²˜ë¦¬ ëª¨ë“ˆ (LLM Processing Module)

#### ìœ„ì¹˜
```
src/llm/llm_processor.py
```

#### í´ë˜ìŠ¤: LLMProcessor

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class LLMProcessor:
    def __init__(self, model: str = "gpt-4o-mini", temperature: float = 0.7)
    def generate_response(
        self,
        query: str,
        retrieved_chunks: List[Dict[str, Any]],
        api_key: Optional[str] = None
    ) -> str
```

**ë‹µë³€ ìƒì„± íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸ + ê²€ìƒ‰ëœ ì²­í¬ ì…ë ¥
    â†“
ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    â”œâ”€ ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°:
    â”‚   [ë¬¸ì„œ 1: {file_name}]
    â”‚   {chunk_text}
    â”‚
    â”‚   [ë¬¸ì„œ 2: {file_name}]
    â”‚   {chunk_text}
    â”‚   ...
    â””â”€ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°:
        "ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    â†“
í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì ìš©
    â”œâ”€ ì‹œìŠ¤í…œ ì—­í• : ë¬¸ì„œ ì°¸ì¡° ë‹µë³€ì
    â”œâ”€ ì»¨í…ìŠ¤íŠ¸: ê²€ìƒ‰ëœ ì²­í¬ë“¤
    â””â”€ ì§ˆë¬¸: ì‚¬ìš©ì ì¿¼ë¦¬
    â†“
LangChainìœ¼ë¡œ LLM í˜¸ì¶œ
    â”œâ”€ ëª¨ë¸: gpt-4o-mini (ê¸°ë³¸ê°’)
    â”œâ”€ Temperature: 0.7
    â””â”€ ì¶œë ¥: í…ìŠ¤íŠ¸ ì‘ë‹µ
    â†“
ì‘ë‹µ ë°˜í™˜
```

**í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿**:
```
ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.

ì°¸ê³  ë¬¸ì„œ:
{context}

ì§ˆë¬¸: {query}

ë‹µë³€:
```

**ì˜ì¡´ì„±**:
- LangChain: LLM ì²´ì¸ êµ¬ì„±
- OpenAI API: LLM í˜¸ì¶œ

---

### 5. ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë“ˆ (Database Module)

#### ìœ„ì¹˜
```
src/db/
â”œâ”€â”€ documents_db.py
â”œâ”€â”€ embeddings_db.py
â””â”€â”€ chat_history_db.py
```

#### 5.1. DocumentsDB

**í…Œì´ë¸” êµ¬ì¡°**:

**TB_DOCUMENTS**:
```sql
CREATE TABLE TB_DOCUMENTS (
    file_hash TEXT PRIMARY KEY,          -- SHA-256 í•´ì‹œ
    file_name TEXT NOT NULL,             -- íŒŒì¼ëª…
    total_pages INTEGER NOT NULL,        -- ì´ í˜ì´ì§€ ìˆ˜
    file_size INTEGER NOT NULL,          -- íŒŒì¼ í¬ê¸° (bytes)
    text_content TEXT,                   -- ì „ì²´ í…ìŠ¤íŠ¸ ì½˜í…ì¸ 
    created_at TIMESTAMP DEFAULT (datetime('now', '+9 hours')),
    updated_at TIMESTAMP DEFAULT (datetime('now', '+9 hours'))
);
```

**íŠ¹ì§•**:
- ë‹¨ì¼ í…Œì´ë¸”ë¡œ í†µí•© (ê¸°ì¡´ file_info + page_data í†µí•©)
- text_contentì— ì „ì²´ ë¬¸ì„œ í…ìŠ¤íŠ¸ ì €ì¥
- í˜ì´ì§€ë³„ ë¶„ë¦¬ ì—†ì´ ì „ì²´ ë‚´ìš©ì„ í•˜ë‚˜ì˜ ì»¬ëŸ¼ì— ì €ì¥

**ì£¼ìš” ë©”ì„œë“œ**:
- `insert_text_content()`: ë¬¸ì„œ ì •ë³´ ë° í…ìŠ¤íŠ¸ ì½˜í…ì¸  ì €ì¥
- `get_document_stats()`: ë¬¸ì„œ í†µê³„ ì¡°íšŒ
- `execute_query()`: ì»¤ìŠ¤í…€ ì¿¼ë¦¬ ì‹¤í–‰
- `summary()`: ë°ì´í„°ë² ì´ìŠ¤ ìš”ì•½ ì •ë³´ ì¶œë ¥

---

#### 5.2. VectorStoreManager

**ìœ„ì¹˜**: `src/vectorstore/vector_store_manager.py`

**ì—­í• **: FAISS ë²¡í„° ì¸ë±ìŠ¤ ë° ë©”íƒ€ë°ì´í„° í†µí•© ê´€ë¦¬

**ì£¼ìš” ê¸°ëŠ¥**:
- FAISS ì¸ë±ìŠ¤ ìƒì„±/ë¡œë“œ/ì €ì¥
- ë²¡í„° ì¶”ê°€ (ë‹¨ì¼/ë°°ì¹˜)
- ìœ ì‚¬ë„ ê²€ìƒ‰
- Document.metadataë¥¼ í†µí•œ ë©”íƒ€ë°ì´í„° ê´€ë¦¬

**ë©”íƒ€ë°ì´í„° êµ¬ì¡°** (Document.metadata):
```python
{
    'file_hash': str,              # íŒŒì¼ í•´ì‹œ
    'file_name': str,              # íŒŒì¼ëª…
    'start_page': int,             # ì‹œì‘ í˜ì´ì§€ ë²ˆí˜¸
    'end_page': int,               # ì¢…ë£Œ í˜ì´ì§€ ë²ˆí˜¸
    'chunk_type': str,             # ì²­í¬ íƒ€ì… (ì˜ˆ: 'paragraph')
    'chunk_index': int,            # ì²­í¬ ì¸ë±ìŠ¤
    'embedding_version': str,      # ì„ë² ë”© ëª¨ë¸ ë²„ì „
    'created_at': str              # ìƒì„± ì‹œê° (ISO format)
}
```

**ì£¼ìš” ë©”ì„œë“œ**:
```python
class VectorStoreManager:
    def __init__(self, config=None)
    def load(self) -> bool
    def create_from_documents(self, texts, metadatas) -> bool
    def add_texts(self, texts, metadatas) -> Tuple[bool, int]
    def save(self) -> bool
    def search(self, query, top_k, filter_metadata) -> List[Tuple[Document, float]]
    def get_vector_count(self) -> int
    def remove_by_file_hash(self, file_hash) -> bool
    def summary(self) -> None
```

**íŠ¹ì§•**:
- **EmbeddingsDB ì œê±°**: ë³„ë„ DB ì—†ì´ FAISS ë‚´ë¶€ ë©”íƒ€ë°ì´í„°ë§Œ ì‚¬ìš©
- **í†µí•© ê´€ë¦¬**: ë²¡í„°ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ FAISS Documentë¡œ í•¨ê»˜ ê´€ë¦¬
- **LangChain í†µí•©**: LangChain FAISS ì¸í„°í˜ì´ìŠ¤ í™œìš©
- **ìë™ ì¸ë±ìŠ¤ ê´€ë¦¬**: ì¸ë±ìŠ¤ ì—†ì„ ì‹œ ë”ë¯¸ ì¸ë±ìŠ¤ ìë™ ìƒì„±

---

#### 5.3. ChatHistoryDB

**í…Œì´ë¸” êµ¬ì¡°**:

**chat_sessions**:
```sql
CREATE TABLE chat_sessions (
    session_id TEXT PRIMARY KEY,         -- UUID
    session_name TEXT NOT NULL,          -- ì„¸ì…˜ ì´ë¦„
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT 1          -- í™œì„± ìƒíƒœ
);
```

**chat_messages**:
```sql
CREATE TABLE chat_messages (
    message_id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,            -- ì„¸ì…˜ ID (FK)
    role TEXT NOT NULL,                  -- 'user' or 'assistant'
    content TEXT NOT NULL,               -- ë©”ì‹œì§€ ë‚´ìš©
    retrieved_chunks TEXT,               -- ê²€ìƒ‰ëœ ì²­í¬ ì •ë³´ (JSON)
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES chat_sessions(session_id) ON DELETE CASCADE
);
```

**ì£¼ìš” ë©”ì„œë“œ**:
- `create_session()`: ìƒˆ ì„¸ì…˜ ìƒì„±
- `add_message()`: ë©”ì‹œì§€ ì¶”ê°€
- `get_session_messages()`: ì„¸ì…˜ ë©”ì‹œì§€ ì¡°íšŒ
- `get_recent_sessions()`: ìµœê·¼ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ
- `get_chat_stats()`: ì±„íŒ… í†µê³„ ì¡°íšŒ

---

### 6. UI ëª¨ë“ˆ (User Interface Module)

#### ìœ„ì¹˜
```
app.py
```

#### êµ¬ì¡°

**ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬**:
```python
st.session_state = {
    'session_id': str,          # í˜„ì¬ ì±„íŒ… ì„¸ì…˜ ID
    'messages': List[Dict],     # í˜„ì¬ ëŒ€í™” ë‚´ì—­
    'api_key': str              # OpenAI API í‚¤
}
```

**ì£¼ìš” ì„¹ì…˜**:

1. **ì‚¬ì´ë“œë°”**:
   - OpenAI API í‚¤ ì…ë ¥
   - ë°ì´í„° í†µê³„ í‘œì‹œ
   - ì±„íŒ… ì„¸ì…˜ ê´€ë¦¬
   - ìƒˆ ì±„íŒ… ì‹œì‘ ë²„íŠ¼
   - ìµœê·¼ ì„¸ì…˜ ëª©ë¡

2. **ë©”ì¸ ì˜ì—­**:
   - ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
   - ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ë°•ìŠ¤
   - ê²€ìƒ‰ ê²°ê³¼ ë° ì¶œì²˜ í‘œì‹œ

3. **ìºì‹±**:
   - `@st.cache_resource`: DB ì¸ìŠ¤í„´ìŠ¤ ìºì‹±
   - ì„±ëŠ¥ ìµœì í™”

---

## ë°ì´í„° íë¦„

### 1. ë¬¸ì„œ ì—…ë¡œë“œ ë° ì²˜ë¦¬ íë¦„

```mermaid
sequenceDiagram
    participant User as ì‚¬ìš©ì
    participant DP as DocumentProcessor
    participant DDB as DocumentsDB
    participant EP as EmbeddingProcessor
    participant VM as VectorStoreManager
    participant FAISS as FAISS Index

    User->>DP: PDF ì—…ë¡œë“œ
    activate DP
    DP->>DP: íŒŒì¼ í•´ì‹œ ê³„ì‚°
    DP->>DP: PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
    DP->>DDB: TB_DOCUMENTS ì €ì¥<br/>(file_hash, text_content)
    deactivate DP

    Note over DDB,EP: íŠ¸ë¦¬ê±°

    activate EP
    EP->>DDB: í…ìŠ¤íŠ¸ ì½˜í…ì¸  ì¡°íšŒ
    DDB-->>EP: ì „ì²´ í…ìŠ¤íŠ¸
    EP->>EP: í…ìŠ¤íŠ¸ ì²­í‚¹<br/>í˜ì´ì§€ ë²”ìœ„ ê³„ì‚°
    EP->>EP: ë©”íƒ€ë°ì´í„° ìƒì„±<br/>(file_name, start_page, end_page)
    EP->>VM: add_texts(chunks, metadatas)
    activate VM
    VM->>VM: OpenAI ì„ë² ë”© ìƒì„±
    VM->>FAISS: ë²¡í„° + ë©”íƒ€ë°ì´í„° ì¶”ê°€
    VM->>VM: save() í˜¸ì¶œ
    deactivate VM
    deactivate EP

    Note over FAISS: vectorstore.faiss íŒŒì¼ ì—…ë°ì´íŠ¸<br/>(ë²¡í„° + Document.metadata)
```

---

### 2. ì§ˆì˜ ì‘ë‹µ íë¦„ (RAG Pipeline)

```mermaid
sequenceDiagram
    participant User as ì‚¬ìš©ì
    participant Ret as Retrieval
    participant VM as VectorStoreManager
    participant FAISS as FAISS Index
    participant LLM as LLMProcessor
    participant OpenAI as OpenAI API
    participant CDB as ChatHistoryDB

    User->>Ret: ì§ˆë¬¸ ì…ë ¥
    activate Ret
    Ret->>VM: search(query, top_k)
    activate VM
    VM->>OpenAI: ì¿¼ë¦¬ ì„ë² ë”© ìƒì„±
    OpenAI-->>VM: ì¿¼ë¦¬ ë²¡í„°
    VM->>FAISS: similarity_search_with_score
    FAISS-->>VM: Documents + scores<br/>(Document.metadata í¬í•¨)
    VM-->>Ret: [(Document, score), ...]
    deactivate VM
    deactivate Ret

    Note over Ret: Document.metadataì—<br/>file_name, page, chunk ì •ë³´ í¬í•¨

    activate LLM
    Ret->>LLM: ê²€ìƒ‰ ê²°ê³¼ ì „ë‹¬
    LLM->>LLM: ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
    LLM->>LLM: í”„ë¡¬í”„íŠ¸ ìƒì„±
    LLM->>OpenAI: LLM API í˜¸ì¶œ
    OpenAI-->>LLM: ë‹µë³€ í…ìŠ¤íŠ¸
    deactivate LLM

    LLM->>CDB: ì§ˆë¬¸ ì €ì¥ (role=user)
    LLM->>CDB: ë‹µë³€ ì €ì¥ (role=assistant)
    LLM->>CDB: retrieved_chunks ì €ì¥ (JSON)

    LLM->>User: ë‹µë³€ í‘œì‹œ
```

---

### 3. ì„¸ì…˜ ê´€ë¦¬ íë¦„

```mermaid
flowchart TD
    A[ìƒˆ ì±„íŒ… ì‹œì‘] --> B[ChatHistoryDB.create_session]
    B --> B1[session_id ìƒì„± UUID]
    B --> B2[session_name ì„¤ì •]
    B1 --> C[st.session_state ì—…ë°ì´íŠ¸]
    B2 --> C
    C --> C1[session_id ì €ì¥]
    C --> C2[messages ì´ˆê¸°í™”]
    C1 --> D[ì‚¬ìš©ì ì§ˆë¬¸]
    C2 --> D
    D --> E[ChatHistoryDB.add_message<br/>role='user']
    E --> F[RAG íŒŒì´í”„ë¼ì¸ ì‹¤í–‰]
    F --> G[ChatHistoryDB.add_message<br/>role='assistant'<br/>retrieved_chunks]
    G --> H[ì„¸ì…˜ updated_at ê°±ì‹ ]
    H --> I{ê³„ì† ëŒ€í™”?}
    I -->|Yes| D
    I -->|No| J[ì„¸ì…˜ ì¢…ë£Œ]

    style A stroke-width:2px,stroke:#e1f5ff
    style F stroke-width:2px,stroke:#fff9e1
    style J stroke-width:2px,stroke:#fce4ec
```

---

## í•µì‹¬ ì»´í¬ë„ŒíŠ¸

### 1. íŒŒì¼ í•´ì‹œ ê¸°ë°˜ ì¤‘ë³µ ì œê±°

**ëª©ì **: ë™ì¼ íŒŒì¼ ì¬ì²˜ë¦¬ ë°©ì§€

**ë©”ì»¤ë‹ˆì¦˜**:
```python
file_hash = hashlib.sha256(file_content).hexdigest()

# documents.db ì¡°íšŒ
if file_hash in database:
    return "ì´ë¯¸ ì²˜ë¦¬ëœ íŒŒì¼ì…ë‹ˆë‹¤"
else:
    process_and_save(file_hash)
```

**ì¥ì **:
- ì¤‘ë³µ ì‘ì—… ë°©ì§€
- ì €ì¥ ê³µê°„ ì ˆì•½
- ì²˜ë¦¬ ì†ë„ í–¥ìƒ

---

### 2. ì„ë² ë”© ì„¤ì • í•´ì‹œ

**ëª©ì **: ë™ì¼ ì„¤ì •ì˜ ì„ë² ë”© ì¬ì‚¬ìš©

**í•´ì‹œ ê³„ì‚°**:
```python
config = {
    'chunk_size': 1000,
    'chunk_overlap': 200,
    'model': 'text-embedding-3-small'
}
embedding_hash = sha256(f"{file_hash}_{json.dumps(config)}".encode())
```

**í™œìš©**:
- ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ ì¬ì„ë² ë”©
- ë‹¤ì–‘í•œ ì„¤ì • ì¡°í•© ê´€ë¦¬
- ì¦ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›

---

### 3. í†µí•© FAISS ì¸ë±ìŠ¤ ë° ë©”íƒ€ë°ì´í„° ê´€ë¦¬

**ëª©ì **: ëª¨ë“  ë¬¸ì„œì˜ ì„ë² ë”©ì„ í•˜ë‚˜ì˜ FAISS ì¸ë±ìŠ¤ë¡œ í†µí•© ê´€ë¦¬í•˜ê³ , ë©”íƒ€ë°ì´í„°ë¥¼ FAISS ë‚´ë¶€ì— í•¨ê»˜ ì €ì¥

**êµ¬í˜„** (VectorStoreManager):
```python
# ë‹¨ì¼ FAISS ì¸ë±ìŠ¤ ê²½ë¡œ
vector_path = "data/vectorstore/vectorstore.faiss"

# ìƒˆ ë¬¸ì„œ ì¶”ê°€ ì‹œ
success, start_index = self.vector_manager.add_texts(
    texts=chunks,
    metadatas=[
        {
            'file_hash': file_hash,
            'file_name': file_name,
            'start_page': start_page,
            'end_page': end_page,
            'chunk_index': i,
            'embedding_version': model_name,
            'created_at': timestamp
        }
        for i in range(len(chunks))
    ]
)
self.vector_manager.save()
```

**íš¨ê³¼**:
- **ì „ì²´ ë¬¸ì„œ í†µí•© ê²€ìƒ‰**: ëª¨ë“  ë¬¸ì„œë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œ ë²ˆì— ê²€ìƒ‰
- **ë©”íƒ€ë°ì´í„° í†µí•© ê´€ë¦¬**: Document.metadataì— ëª¨ë“  ì •ë³´ ì €ì¥
- **ë³„ë„ DB ë¶ˆí•„ìš”**: EmbeddingsDB ì œê±°ë¡œ ì•„í‚¤í…ì²˜ ë‹¨ìˆœí™”
- **ì •í™•í•œ ì¶œì²˜ ì¶”ì **: íŒŒì¼ëª…, í˜ì´ì§€ ë²ˆí˜¸ ìë™ í¬í•¨
- **ê´€ë¦¬ ìš©ì´ì„±**: ë‹¨ì¼ ì¸í„°í˜ì´ìŠ¤(VectorStoreManager)ë¡œ ëª¨ë“  ì‘ì—… ì²˜ë¦¬

---

### 4. ìœ ì‚¬ë„ ì ìˆ˜ (ê±°ë¦¬ ê¸°ë°˜)

**FAISS L2 ê±°ë¦¬ ê°’ ì§ì ‘ ì‚¬ìš©**:

VectorStoreManagerì˜ `similarity_search_with_score` ë©”ì„œë“œëŠ” FAISSì˜ L2 ê±°ë¦¬ ê°’ì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.

**ë°˜í™˜ í˜•ì‹**:
```python
# VectorStoreManager.search() ë°˜í™˜ê°’
results: List[Tuple[Document, float]]
# [(Document, distance), ...]
```

ì—¬ê¸°ì„œ:
- `distance`: FAISS L2 ê±°ë¦¬ (Euclidean distance)
- ê±°ë¦¬ê°€ **ì‘ì„ìˆ˜ë¡** ìœ ì‚¬ë„ê°€ **ë†’ìŒ**
- ê±°ë¦¬ ë²”ìœ„: 0 ~ âˆ (ê±°ë¦¬ ê¸°ë°˜ì´ë¯€ë¡œ ì •ê·œí™”í•˜ì§€ ì•ŠìŒ)

**íŠ¹ì§•**:
- **ê±°ë¦¬ = 0**: ì™„ì „ ì¼ì¹˜ (ê°€ì¥ ìœ ì‚¬)
- **ê±°ë¦¬ê°€ ì‘ì„ìˆ˜ë¡**: ë†’ì€ ìœ ì‚¬ë„
- **ê±°ë¦¬ê°€ í´ìˆ˜ë¡**: ë‚®ì€ ìœ ì‚¬ë„
- **ì •ê·œí™” ì—†ìŒ**: ì›ë³¸ L2 ê±°ë¦¬ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©

**ê±°ë¦¬ ê°’ í•´ì„**:

```mermaid
graph LR
    A[FAISS ê²€ìƒ‰] --> B[L2 Distance ë°˜í™˜]
    B --> C[ê±°ë¦¬ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©]

    subgraph "ê±°ë¦¬ ê¸°ë°˜ í•´ì„"
        D["ì‘ì€ ê°’ = ë†’ì€ ìœ ì‚¬ë„<br/>í° ê°’ = ë‚®ì€ ìœ ì‚¬ë„"]
    end

    C -.-> D

    style A stroke-width:2px,stroke:#e1f5ff
    style C stroke-width:2px,stroke:#e8f5e9
    style D stroke-width:2px,stroke:#fff9e1
```

| Distance | í•´ì„ |
|----------|------|
| 0.0 | ì™„ì „ ì¼ì¹˜ (ê°€ì¥ ìœ ì‚¬) |
| 0.1 ~ 0.5 | ë§¤ìš° ë†’ì€ ìœ ì‚¬ë„ |
| 0.5 ~ 1.0 | ë†’ì€ ìœ ì‚¬ë„ |
| 1.0 ~ 2.0 | ì¤‘ê°„ ìœ ì‚¬ë„ |
| 2.0 ì´ìƒ | ë‚®ì€ ìœ ì‚¬ë„ |

**ì¥ì **:
- ì›ë³¸ ê±°ë¦¬ ë©”íŠ¸ë¦­ ë³´ì¡´
- ì •ê·œí™”ë¡œ ì¸í•œ ì •ë³´ ì†ì‹¤ ì—†ìŒ
- ë²¡í„° ê³µê°„ì—ì„œì˜ ì‹¤ì œ ê±°ë¦¬ ë°˜ì˜

---

### 5. ê²€ìƒ‰ëœ ì²­í¬ JSON ì €ì¥

**ëª©ì **: ë‹µë³€ ìƒì„±ì— ì‚¬ìš©ëœ ì¶œì²˜ ì¶”ì 

**êµ¬ì¡°**:
```json
[
    {
        "chunk_text": "...",
        "file_name": "document.pdf",
        "file_hash": "abc123...",
        "start_page": 5,
        "end_page": 5,
        "chunk_index": 0,
        "distance": 0.176,
        "metadata": {
            "chunk_type": "paragraph",
            "embedding_version": "text-embedding-3-small",
            "created_at": "2025-11-13T..."
        }
    },
    ...
]
```

**íŠ¹ì§•**:
- **distance**: FAISS L2 ê±°ë¦¬ ê°’ (ì‘ì„ìˆ˜ë¡ ìœ ì‚¬ë„ ë†’ìŒ)
- **ë©”íƒ€ë°ì´í„°**: Document.metadataì˜ ëª¨ë“  ì •ë³´ í¬í•¨
- **ì¶œì²˜ ì •ë³´**: file_name, start_page, end_page ëª…ì‹œ

**í™œìš©**:
- ë‹µë³€ ê·¼ê±° ì œì‹œ (íŒŒì¼ëª…, í˜ì´ì§€ ë²ˆí˜¸)
- ì¶œì²˜ í‘œì‹œ (ì •í™•í•œ ìœ„ì¹˜ ì¶”ì )
- í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ (ê±°ë¦¬ ê°’ ê¸°ë°˜ ê²€ìƒ‰ í’ˆì§ˆ í‰ê°€)

---

## ê¸°ìˆ  ìŠ¤íƒ

### ë°±ì—”ë“œ

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ  | ë²„ì „ | ìš©ë„ |
|---------|------|------|------|
| ì–¸ì–´ | Python | 3.8+ | ì£¼ ê°œë°œ ì–¸ì–´ |
| ë¬¸ì„œ ì²˜ë¦¬ | PyMuPDF | latest | PDF íŒŒì‹± ë° í…ìŠ¤íŠ¸ ì¶”ì¶œ |
| í† í° ê³„ì‚° | tiktoken | latest | GPT tokenizer |
| í…ìŠ¤íŠ¸ ë¶„í•  | LangChain | latest | RecursiveCharacterTextSplitter |
| ì„ë² ë”© | OpenAI API | latest | text-embedding-3-small |
| ë²¡í„° DB | FAISS | latest | ìœ ì‚¬ë„ ê²€ìƒ‰ |
| LLM | OpenAI API | latest | gpt-4o-mini |
| ë°ì´í„°ë² ì´ìŠ¤ | SQLite | 3.x | ë©”íƒ€ë°ì´í„° ì €ì¥ |

### í”„ë¡ íŠ¸ì—”ë“œ

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ  | ìš©ë„ |
|---------|------|------|
| UI í”„ë ˆì„ì›Œí¬ | Streamlit | ì›¹ ì¸í„°í˜ì´ìŠ¤ |
| ìƒíƒœ ê´€ë¦¬ | st.session_state | ì„¸ì…˜ ê´€ë¦¬ |
| ìºì‹± | @st.cache_resource | ì„±ëŠ¥ ìµœì í™” |

### ìœ í‹¸ë¦¬í‹°

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ  | ìš©ë„ |
|---------|------|------|
| í•´ì‹± | hashlib | SHA-256 |
| JSON | json | ì„¤ì • ì§ë ¬í™” |
| ë‚ ì§œ/ì‹œê°„ | datetime | íƒ€ì„ìŠ¤íƒ¬í”„ |
| ê²½ë¡œ ê´€ë¦¬ | pathlib | íŒŒì¼ ê²½ë¡œ ì²˜ë¦¬ |
| ìˆ˜ì¹˜ ì—°ì‚° | numpy | ë²¡í„° ì—°ì‚° |

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
codeit_ai_g2b_search/
â”‚
â”œâ”€â”€ app.py                          # Streamlit ë©”ì¸ ì•±
â”œâ”€â”€ requirements.txt                # Python ì˜ì¡´ì„±
â”œâ”€â”€ .env.example                    # í™˜ê²½ ë³€ìˆ˜ ì˜ˆì‹œ
â”œâ”€â”€ README.md                       # í”„ë¡œì íŠ¸ ì„¤ëª…
â”‚
â”œâ”€â”€ src/                            # ì†ŒìŠ¤ ì½”ë“œ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                         # ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë“ˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ documents_db.py         # ë¬¸ì„œ DB ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ chat_history_db.py      # ì±„íŒ… íˆìŠ¤í† ë¦¬ DB ê´€ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ processors/                 # ì²˜ë¦¬ ëª¨ë“ˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ document_processor.py   # ë¬¸ì„œ ì²˜ë¦¬
â”‚   â”‚   â””â”€â”€ embedding_processor.py  # ì„ë² ë”© ì²˜ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/                        # LLM ê´€ë ¨ ëª¨ë“ˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ retrieval.py            # ê²€ìƒ‰ ê¸°ëŠ¥
â”‚   â”‚   â””â”€â”€ llm_processor.py        # LLM ë‹µë³€ ìƒì„±
â”‚   â”‚
â”‚   â”œâ”€â”€ ui/                         # UI ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # ìœ í‹¸ë¦¬í‹°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ helper_utils.py         # í—¬í¼ í•¨ìˆ˜
â”‚       â””â”€â”€ logging_config.py       # ë¡œê¹… ì„¤ì •
â”‚
â”œâ”€â”€ data/                           # ë°ì´í„° ë””ë ‰í† ë¦¬
â”‚   â”œâ”€â”€ documents.db                # ë¬¸ì„œ í…ìŠ¤íŠ¸ ì½˜í…ì¸  DB
â”‚   â”œâ”€â”€ chat_history.db             # ì±„íŒ… íˆìŠ¤í† ë¦¬ DB
â”‚   â”‚
â”‚   â”œâ”€â”€ raw/                        # ì›ë³¸ íŒŒì¼
â”‚   â”‚   â”œâ”€â”€ *.pdf
â”‚   â”‚   â””â”€â”€ *.hwp
â”‚   â”‚
â”‚   â””â”€â”€ vectorstore/                # í†µí•© FAISS ì¸ë±ìŠ¤
â”‚       â”œâ”€â”€ vectorstore.faiss       # ë²¡í„° ì¸ë±ìŠ¤ (ë©”íƒ€ë°ì´í„° í¬í•¨)
â”‚       â””â”€â”€ vectorstore.pkl         # FAISS ì¸ë±ìŠ¤ ë©”íƒ€ë°ì´í„°
â”‚
â”œâ”€â”€ docs/                           # ë¬¸ì„œ
â”‚   â”œâ”€â”€ doc/
â”‚   â”‚   â”œâ”€â”€ RAG_ê¸°ë°˜_PEP_ë¬¸ì„œ_ì²˜ë¦¬_ì‹œìŠ¤í…œ_ì„¤ê³„ì„œ.md
â”‚   â”‚   â”œâ”€â”€ ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_ì„¤ê³„ì„œ.md
â”‚   â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸_ì²´í¬ë¦¬ìŠ¤íŠ¸.md
â”‚   â”‚   â””â”€â”€ ê°œë°œìë³„_ì²´í¬ë¦¬ìŠ¤íŠ¸.md
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ API_ë¬¸ì„œ.md
â”‚
â”œâ”€â”€ tests/                          # í…ŒìŠ¤íŠ¸ ì½”ë“œ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_document_processor.py
â”‚   â”œâ”€â”€ test_embedding_processor.py
â”‚   â””â”€â”€ test_retrieval.py
â”‚
â””â”€â”€ scripts/                        # ìœ í‹¸ë¦¬í‹° ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ setup.sh                    # ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
    â””â”€â”€ bulk_process.py             # ëŒ€ëŸ‰ ë¬¸ì„œ ì²˜ë¦¬
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ER ë‹¤ì´ì–´ê·¸ë¨

```mermaid
erDiagram
    TB_DOCUMENTS {
        string file_hash PK
        string file_name
        int total_pages
        int file_size
        text text_content
        timestamp created_at
        timestamp updated_at
    }

    FAISS_INDEX {
        int vector_id PK
        blob vector_embedding
        json metadata
    }

    FAISS_METADATA {
        string file_hash
        string file_name
        int start_page
        int end_page
        string chunk_type
        int chunk_index
        string embedding_version
        string created_at
    }

    chat_sessions ||--o{ chat_messages : "includes"
    chat_sessions {
        string session_id PK
        string session_name
        timestamp created_at
        timestamp updated_at
        boolean is_active
    }
    chat_messages {
        int message_id PK
        string session_id FK
        string role
        text content
        text retrieved_chunks
        timestamp timestamp
    }

    TB_DOCUMENTS ||--o{ FAISS_INDEX : "generates"
    FAISS_INDEX ||--|| FAISS_METADATA : "contains"
```

---

## ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 1. ìºì‹± ì „ëµ

**Streamlit ìºì‹±**:
```python
@st.cache_resource
def init_dbs():
    return {
        'docs': DocumentsDB(),
        'embeddings': EmbeddingsDB(),
        'chat': ChatHistoryDB()
    }
```

**íš¨ê³¼**:
- DB ì—°ê²° ì¬ì‚¬ìš©
- ì´ˆê¸°í™” ì‹œê°„ ë‹¨ì¶•
- ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ

---

### 2. ë°°ì¹˜ ì²˜ë¦¬

**ì„ë² ë”© ë°°ì¹˜ ìƒì„±**:
```python
# í•œ ë²ˆì— ì—¬ëŸ¬ ì²­í¬ ì„ë² ë”©
embeddings = self.embeddings.embed_documents(chunks)
```

**ì¥ì **:
- API í˜¸ì¶œ íšŸìˆ˜ ê°ì†Œ
- ì²˜ë¦¬ ì†ë„ í–¥ìƒ
- ë¹„ìš© ì ˆê°

---

### 3. ì¸ë±ìŠ¤ ìµœì í™”

**FAISS ì¸ë±ìŠ¤ ì„ íƒ**:
- `IndexFlatL2`: ì •í™•ë„ ìµœìš°ì„  (í˜„ì¬ ì‚¬ìš©)
- `IndexIVFFlat`: ëŒ€ìš©ëŸ‰ ë°ì´í„° (í–¥í›„ ê³ ë ¤)
- `IndexHNSW`: ì†ë„ì™€ ì •í™•ë„ ê· í˜•

---

### 4. DB ìµœì í™”

**ì¸ë±ìŠ¤ ìƒì„±**:
```sql
CREATE INDEX idx_file_hash ON page_data(file_hash);
CREATE INDEX idx_embedding_hash ON chunk_mapping(embedding_hash);
CREATE INDEX idx_vector_index ON chunk_mapping(vector_index);
CREATE INDEX idx_session_id ON chat_messages(session_id);
```

---

## í™•ì¥ ê°€ëŠ¥ì„±

### í–¥í›„ ê°œì„  ë¡œë“œë§µ

```mermaid
mindmap
  root((RAG ì‹œìŠ¤í…œ<br/>í™•ì¥))
    ë¬¸ì„œ ì²˜ë¦¬
      HWP ì§€ì›
      DOCX, TXT
      HTML íŒŒì‹±
      ì´ë¯¸ì§€ OCR
      í‘œ êµ¬ì¡° ì¸ì‹
    ì„ë² ë”©
      ë¡œì»¬ ëª¨ë¸
        Sentence Transformers
        HuggingFace
      ë©€í‹°ëª¨ë‹¬
        ì´ë¯¸ì§€ ì„ë² ë”©
        CLIP ëª¨ë¸
      ë‹¤êµ­ì–´ ì§€ì›
    ê²€ìƒ‰
      í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰
        í‚¤ì›Œë“œ + ë²¡í„°
        BM25 í†µí•©
      ë©”íƒ€ë°ì´í„° í•„í„°
        ë‚ ì§œ ë²”ìœ„
        íŒŒì¼ íƒ€ì…
        íƒœê·¸ ì‹œìŠ¤í…œ
      ë¦¬ë­í‚¹
        Cross-Encoder
        LLM ê¸°ë°˜
    ì¸í”„ë¼
      ë°ì´í„°ë² ì´ìŠ¤
        PostgreSQL
        pgvector
      ìºì‹±
        Redis
        Memcached
      ë¶„ì‚° ì²˜ë¦¬
        Celery
        Ray
      ëª¨ë‹ˆí„°ë§
        Prometheus
        Grafana
```

### 1. ë‹¤ì–‘í•œ ë¬¸ì„œ íƒ€ì… ì§€ì›

**í™•ì¥ êµ¬ì¡°**:
```mermaid
classDiagram
    class DocumentParser {
        <<interface>>
        +parse(file_path) str
        +get_metadata() dict
    }
    class PDFParser {
        +parse(file_path) str
    }
    class HWPParser {
        +parse(file_path) str
    }
    class DOCXParser {
        +parse(file_path) str
    }
    class HTMLParser {
        +parse(file_path) str
    }

    DocumentParser <|-- PDFParser
    DocumentParser <|-- HWPParser
    DocumentParser <|-- DOCXParser
    DocumentParser <|-- HTMLParser
```

- HWP ì²˜ë¦¬ê¸° ì¶”ê°€
- DOCX, TXT, HTML ë“± ì§€ì›
- ë¬¸ì„œ íƒ€ì…ë³„ íŒŒì„œ ì¸í„°í˜ì´ìŠ¤

### 2. ë¡œì»¬ ì„ë² ë”© ëª¨ë¸
- **Sentence Transformers**: ì˜¤í”ˆì†ŒìŠ¤ ì„ë² ë”© ëª¨ë¸
- **HuggingFace ëª¨ë¸**: ë‹¤ì–‘í•œ ì‚¬ì „í•™ìŠµ ëª¨ë¸
- **ë¹„ìš© ì ˆê°**: OpenAI API ë¹„ìš© ì œê±°
- **í”„ë¼ì´ë²„ì‹œ ê°•í™”**: ë¡œì»¬ ì²˜ë¦¬

### 3. ê³ ê¸‰ ê²€ìƒ‰ ê¸°ëŠ¥
- **ë©”íƒ€ë°ì´í„° í•„í„°ë§**: ë‚ ì§œ, íŒŒì¼ íƒ€ì…, íƒœê·¸ ë“±
- **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**: í‚¤ì›Œë“œ(BM25) + ë²¡í„° ê²€ìƒ‰
- **ë¦¬ë­í‚¹**: Cross-Encoder ë˜ëŠ” LLM ê¸°ë°˜ ì¬ì •ë ¬

### 4. ë©€í‹°ëª¨ë‹¬ ì§€ì›
- **ì´ë¯¸ì§€ ì„ë² ë”©**: CLIP ëª¨ë¸ í™œìš©
- **í‘œ êµ¬ì¡° ì¸ì‹**: í…Œì´ë¸” ì „ìš© íŒŒì‹±
- **OCR í†µí•©**: ì´ë¯¸ì§€ ë‚´ í…ìŠ¤íŠ¸ ì¶”ì¶œ

### 5. ìŠ¤ì¼€ì¼ë§
- **PostgreSQL + pgvector**: ëŒ€ìš©ëŸ‰ ë²¡í„° DB
- **Redis ìºì‹±**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ê²€ìƒ‰ ê²°ê³¼ ìºì‹±
- **ë¶„ì‚° ì²˜ë¦¬**: Celery/Rayë¥¼ í†µí•œ ë³‘ë ¬ ì²˜ë¦¬

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. API í‚¤ ê´€ë¦¬
```python
# í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬
api_key = os.getenv('OPENAI_API_KEY')

# ì„¸ì…˜ ìƒíƒœì— ì €ì¥ (ì•”í˜¸í™”ëœ ì…ë ¥)
api_key = st.text_input("API Key", type="password")
```

### 2. íŒŒì¼ ì—…ë¡œë“œ ê²€ì¦
- íŒŒì¼ í¬ê¸° ì œí•œ
- MIME íƒ€ì… ê²€ì¦
- ì•…ì„± íŒŒì¼ ìŠ¤ìº”

### 3. SQL Injection ë°©ì§€
```python
# íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
cursor.execute("SELECT * FROM file_info WHERE file_hash = ?", (file_hash,))
```

### 4. ì ‘ê·¼ ì œì–´
- ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦
- ì‚¬ìš©ìë³„ ë°ì´í„° ê²©ë¦¬
- ê°ì‚¬ ë¡œê·¸

---

## ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### ë¡œê¹… ì „ëµ

**ë ˆë²¨**:
- DEBUG: ìƒì„¸ ì²˜ë¦¬ ê³¼ì •
- INFO: ì£¼ìš” ì´ë²¤íŠ¸ (íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ, ê²€ìƒ‰ ìš”ì²­ ë“±)
- WARNING: ê²½ê³  (API ì§€ì—°, ê²€ìƒ‰ ê²°ê³¼ ë¶€ì¡± ë“±)
- ERROR: ì˜¤ë¥˜ (API ì‹¤íŒ¨, íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ ë“±)

**ë¡œê·¸ ìœ„ì¹˜**:
```
logs/
â”œâ”€â”€ app.log              # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸
â”œâ”€â”€ document.log         # ë¬¸ì„œ ì²˜ë¦¬ ë¡œê·¸
â”œâ”€â”€ embedding.log        # ì„ë² ë”© ë¡œê·¸
â””â”€â”€ llm.log              # LLM ìš”ì²­/ì‘ë‹µ ë¡œê·¸
```

---

## ê²°ë¡ 

ë³¸ ì‹œìŠ¤í…œì€ **ëª¨ë“ˆí™”**, **í™•ì¥ì„±**, **ì¶”ì ì„±**ì„ í•µì‹¬ ì„¤ê³„ ì›ì¹™ìœ¼ë¡œ í•˜ì—¬ RAG ê¸°ë°˜ì˜ ë¬¸ì„œ ê²€ìƒ‰ ë° ì§ˆì˜ì‘ë‹µ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### í•µì‹¬ ê°•ì 
1. **íŒŒì¼ í•´ì‹œ ê¸°ë°˜ ì„¤ê³„**: ì¤‘ë³µ ì œê±° ë° ì¦ë¶„ ì—…ë°ì´íŠ¸ ì§€ì›
2. **ê³„ì¸µí™”ëœ ì•„í‚¤í…ì²˜**: ê° ê³„ì¸µì˜ ë…ë¦½ì„± ë³´ì¥
3. **ìœ ì—°í•œ í™•ì¥ì„±**: ìƒˆë¡œìš´ ëª¨ë¸ ë° ê¸°ëŠ¥ ì¶”ê°€ ìš©ì´
4. **ì™„ì „í•œ ì¶”ì ì„±**: ëª¨ë“  ë‹µë³€ì˜ ì¶œì²˜ ì¶”ì  ê°€ëŠ¥

### í–¥í›„ ê°œì„  ë°©í–¥
1. ë¶„ì‚° ì²˜ë¦¬ ë° ìŠ¤ì¼€ì¼ë§
2. ê³ ê¸‰ ê²€ìƒ‰ ê¸°ëŠ¥ (í•˜ì´ë¸Œë¦¬ë“œ, ë¦¬ë­í‚¹)
3. ë©€í‹°ëª¨ë‹¬ ì§€ì›
4. ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ í•™ìŠµ

---

**ë¬¸ì„œ ë²„ì „**: 3.0
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-13
**ì‘ì„±ì**: í”„ë¡œì íŠ¸ íŒ€

**ì£¼ìš” ë³€ê²½ì‚¬í•­ (v3.0)**:
- **EmbeddingsDB ì™„ì „ ì œê±°**: ë³„ë„ ì„ë² ë”© DB ì—†ì´ FAISS ë‚´ë¶€ ë©”íƒ€ë°ì´í„°ë§Œ ì‚¬ìš©
- **VectorStoreManager ë„ì…**: FAISS ì¸ë±ìŠ¤ ë° ë©”íƒ€ë°ì´í„° í†µí•© ê´€ë¦¬
- **DocumentsDB ë‹¨ìˆœí™”**: TB_DOCUMENTS í…Œì´ë¸” í•˜ë‚˜ë¡œ í†µí•© (text_content ì €ì¥)
- **ë©”íƒ€ë°ì´í„° í†µí•©**: Document.metadataì— íŒŒì¼ëª…, í˜ì´ì§€ ë²ˆí˜¸, ì²­í¬ ì •ë³´ ëª¨ë‘ ì €ì¥
- **ì•„í‚¤í…ì²˜ ë‹¨ìˆœí™”**: 3ê°œ DB â†’ 2ê°œ DB (documents.db, chat_history.db)
- **ê´€ë¦¬ íš¨ìœ¨ì„±**: ë‹¨ì¼ ì¸í„°í˜ì´ìŠ¤(VectorStoreManager)ë¡œ ëª¨ë“  ë²¡í„° ì‘ì—… ì²˜ë¦¬
